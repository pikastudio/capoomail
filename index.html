<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Capoomail</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body { font-family:"Segoe UI",Arial,sans-serif; background:linear-gradient(135deg,#74ebd5,#ACB6E5);
      display:flex; flex-direction:column; align-items:center; padding:20px; min-height:100vh; margin:0; }
    h1 { font-size:2.5em; margin-bottom:20px; color:#2c3e50; }
    #loginBtn,#sendBtn,#saveAddressBtn { background:#3498db; color:white; border:none; padding:12px 25px;
      font-size:1.1em; border-radius:8px; cursor:pointer; transition:all 0.3s ease; margin-top:15px; }
    #loginBtn:hover,#sendBtn:hover,#saveAddressBtn:hover { background:#2980b9; transform:scale(1.05); }
    #emailForm { display:none; flex-direction:column; margin-top:20px; width:300px; }
    input,textarea { margin:8px 0; padding:10px; border-radius:6px; border:1px solid #ccc; }
    textarea { resize:vertical; min-height:100px; }
    #inbox { margin-top:30px; width:80%; max-width:600px; background:#fff; padding:15px; border-radius:8px;
      box-shadow:0 4px 6px rgba(0,0,0,0.2); display:none; }
    .message { border-bottom:1px solid #ddd; padding:10px 0; }
    .message:last-child { border-bottom:none; }
    .from { font-weight:bold; color:#3498db; }
    .subject { font-style:italic; }
  </style>
</head>
<body>
  <h1>Welcome to Capoomail üêæ</h1>
  <button id="loginBtn">Login / Signup with GitHub</button>

  <!-- Email creation form -->
  <form id="emailForm">
    <div id="chooseAddress">
      <label>
        Choose your Capoomail address (one time only):
        <div style="display:flex;align-items:center;">
          <input type="text" id="senderName" placeholder="yourname" required>
          <span>@capoomail.com</span>
        </div>
      </label>
      <button type="button" id="saveAddressBtn">Save Address</button>
    </div>

    <input type="text" id="to" placeholder="Recipient email" required>
    <input type="text" id="subject" placeholder="Subject" required>
    <textarea id="body" placeholder="Write your message..." required></textarea>
    <button type="button" id="sendBtn">Send Email</button>
  </form>

  <!-- Inbox -->
  <div id="inbox">
    <h2>Your Shrine Inbox</h2>
    <div id="messages"></div>
  </div>

  <script>
    // Firebase config
    var firebaseConfig = {
      apiKey: "AIzaSyAPkWlmoajpN7OaOcgtLXtWdFgogvLm2pc",
      authDomain: "capoomail-backend.firebaseapp.com",
      databaseURL: "https://capoomail-backend-default-rtdb.firebaseio.com",
      projectId: "capoomail-backend",
      storageBucket: "capoomail-backend.appspot.com",
      messagingSenderId: "896867372320",
      appId: "1:896867372320:web:0a7fa3ae917295f6269b45"
    };
    firebase.initializeApp(firebaseConfig);

    var auth = firebase.auth();
    var db = firebase.database();
    var provider = new firebase.auth.GithubAuthProvider();

    var loginBtn = document.getElementById("loginBtn");
    var emailForm = document.getElementById("emailForm");
    var sendBtn = document.getElementById("sendBtn");
    var saveAddressBtn = document.getElementById("saveAddressBtn");
    var messagesDiv = document.getElementById("messages");
    var inboxDiv = document.getElementById("inbox");

    var currentAddress = null;
    var currentUser = null;

    // Login ritual
    loginBtn.addEventListener("click", function() {
      auth.signInWithPopup(provider)
        .then(function(result) {
          currentUser = result.user;
          alert("Signed in! Checking shrine identity‚Ä¶");

          // Check if user already has a Capoomail address
          db.ref("users/" + currentUser.uid).once("value").then(snapshot => {
            if (snapshot.exists() && snapshot.val().capooAddress) {
              currentAddress = snapshot.val().capooAddress;
              alert("Your Capoomail address: " + currentAddress);
              document.getElementById("chooseAddress").style.display = "none";
              startInboxListener();
            } else {
              alert("Choose your Capoomail address (one time only).");
              document.getElementById("chooseAddress").style.display = "block";
            }
            emailForm.style.display = "flex";
            loginBtn.style.display = "none";
          });
        })
        .catch(function(error) {
          alert("Error: " + error.message);
        });
    });

    // Save one-time Capoomail address with uniqueness check + welcome mail
    saveAddressBtn.addEventListener("click", function() {
      var senderName = document.getElementById("senderName").value.trim().toLowerCase();
      if (!senderName) { alert("Please enter a name."); return; }
      var desiredAddress = senderName + "@capoomail.com";

      // Check if address already taken
      db.ref("users").orderByChild("capooAddress").equalTo(desiredAddress)
        .once("value").then(snapshot => {
          if (snapshot.exists()) {
            alert("That Capoomail address is already taken!");
          } else {
            currentAddress = desiredAddress;
            db.ref("users/" + currentUser.uid).set({
              capooAddress: currentAddress,
              createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
              alert("Your Capoomail address is set: " + currentAddress);
              document.getElementById("chooseAddress").style.display = "none";
              startInboxListener();

              // Auto-send welcome message
              var messageId = Date.now().toString();
              db.ref("messages/" + messageId).set({
                from: "capoohelper@capoo.com",
                to: currentAddress,
                subject: "Hi",
                body: "hi",
                timestamp: firebase.database.ServerValue.TIMESTAMP
              });
            });
          }
        });
    });

    // Send message
    sendBtn.addEventListener("click", function() {
      if (!currentAddress) {
        alert("You must set your Capoomail address first.");
        return;
      }
      var to = document.getElementById("to").value.trim().toLowerCase();
      var subject = document.getElementById("subject").value;
      var body = document.getElementById("body").value;

      var messageId = Date.now().toString();
      db.ref("messages/" + messageId).set({
        from: currentAddress,
        to: to,
        subject: subject,
        body: body,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      }).then(() => {
        alert("Message sent from " + currentAddress + " to " + to + "!");
        document.getElementById("emailForm").reset();
      }).catch((error) => {
        alert("Error sending message: " + error.message);
      });
    });

    // Realtime inbox listener
    function startInboxListener() {
      inboxDiv.style.display = "block";
      db.ref("messages").orderByChild("to").equalTo(currentAddress)
        .on("child_added", function(snapshot) {
          var msg = snapshot.val();
          var div = document.createElement("div");
          div.className = "message";
          div.innerHTML = "<div class='from'>From: " + msg.from + "</div>" +
                          "<div class='subject'>Subject: " + msg.subject + "</div>" +
                          "<div>" + msg.body + "</div>";
          messagesDiv.prepend(div);
        });
    }
  </script>
</body>
</html>
